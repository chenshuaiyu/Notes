# 4.引入流

### 4.1 流是什么

流是Java API的新成员，允许以声明性处理方式处理集合。可以把它们看成遍历数据集的高级迭代器。此外，流还可以透明的并行处理，无需写任何多线程代码。

### 4.2 流简介

Java8的集合支持一个新的stream方法，它会返回一个流（接口定义在java.util.stream.Stream里）。

流是从支持数据处理操作的源生成的元素序列。

- 元素序列：就像集合一样，流也提供了一个接口，可以访问特定元素类型的一组有序值。因为集合是数据结构，所以它的主要目的是以特定的时间/空间复杂度存储和访问元素（如ArrayList与LinkedList）。但流的目的在于表达计算，比如前面见到的filter，sorted，map。集合讲的是数据，流讲的是计算。
- 源：流会使用一个提供数据的源，如集合，数据或输入，输出资源。注意：从有序集合生成流时会保留原有的顺序。由列表生成的流，其元素顺序与列表一致。
- 数据处理操作：流的数据处理功能支持类似于数据库的操作，以及函数式编程语言中的常用操作，如filter，map，reduce，find，match，sort等。流操作可以顺序执行，也可以并行执行。

流操作的两个重要特点：

1. 流水线：很多流操作本身会返回一个流，这样多个操作可以链接起来，形成一个大的流水线。
2. 内部迭代：与使用迭代器显示迭代的集合不同，流的迭代操作是在背后进行的。

### 4.3 流与集合

集合是一个内存中的数据结构，它包含数据结构中目前所有的值。

流是在概念上固定的数据结构（不能添加和删除元素），其元素则是按需计算的。从另一个角度来说，**流像是一个延迟创建的集合，只要在消费者要求的时候才会计算值**。

#### 4.3.1 只能遍历一次

和迭代器一样，流只能遍历一次，遍历完之后，这个流就被消费掉了。可以从原始数据那里再获得一个新的流来重新遍历一次，就像迭代器一样。流只能消费一次。

#### 4.3.2 外部迭代和内部迭代

使用Collection接口需要用户去做迭代（比如for-each），这称为外部迭代。相反，Stream库使用内部迭代（它帮你把迭代做了，还把得到的流值存在了某个地方，只需要给出一个函数说干什么就干什么）。

### 4.4 流操作

java.util.stream.Stream接口中定义了许多操作。分为两类：

- 中间操作：会返回一个流，这让多个操作可以连接起来形成一个查询，除非流水线上触发一个终端操作，否则中间操作不会执行任何操作。中间操作在终端操作一次性全部处理。
- 终端操作：会从流的流水线生成结果。 其结果是任何不是流的值。

#### 4.4.3 使用流

流的使用：

1. 一个数据源（如集合）来执行一个查询。
2. 一个中间操作链，形成一个流的流水线。
3. 一个终端操作，执行流水线，并能生成结果。

| 操作     | 类型 | 返回类型   | 操作参数       | 函数描述符   |
| -------- | ---- | ---------- | -------------- | ------------ |
| filter   | 中间 | Stream\<T> | Predicate\<T>  | T -> boolean |
| map      | 中间 | Stream\<T> | Function\<T>   | T -> R       |
| limit    | 中间 | Stream\<T> |                |              |
| sorted   | 中间 | Stream\<T> | Comparator\<T> | (T,T) -> int |
| distinct | 中间 | Stream\<T> |                |              |



| 操作    | 类型 | 目的                                                 |
| ------- | ---- | ---------------------------------------------------- |
| foreach | 终端 | 消费流中的每个元素并对其应用Lambda。这一操作返回void |
| count   | 终端 | 返回流中的元素的个数。这一操作返回long               |
| collet  | 终端 | 把流规约成一个集合，比如List，Map甚至是Integer。     |

### 4.5 小结

- 流是“从支持数据处理操作的源生成的一系列元素”。
- 流利用内部迭代：迭代通过filter，map，sorted等操作被抽象掉了。
- 流操作有两类：中间操作和终端操作。
- filter和map等中间操作会返回一个流，并可以链接在一起。可以用它们来设置一条流水线，但并不会生成任何结果。
- forEach和count等终端操作会返回一个非流的值，并处理流水以返回结果。
- 流中的元素是按需计算的。