

# TCP

### 1. 概述

#### 1.TCP最主要的特点

1. TCP是面向连接的运输层协议。这就是说，应用程序在使用TCP协议之前，必须先建立TCP连接。在传输数据完毕后，必须释放已经建立的TCP连接。也就是说，应用进程之间的通信好像在打电话：通话之前要先拨号建立连接，通话结束后要挂机释放连接。
2. 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的（一对一）。
3. TCP提供可靠交付的服务。通过TCP连接传送的数据，无差错、不丢失、不重复，并且按序到达。
4. TCP提供全双工通信。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接受缓存，用来临时存放双向通信的数据。在发送时，应用程序在把数据传送给TCP的缓存后，就可以做自己的事，而TCP在合适的时候把数据发送从出去。在接收时，TCP把收到的的数据存入缓存，上层的应用程序在合适的时候读取缓存中的数据。
5. 面向字节流。TCP中的“流”指的是流入到进程或从进程流出的字节序列。“面向字节流”的含义是：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序交下来的数据仅仅看成是一连串的无结构的字节流。TCP并不知道所传送的字节流的含义。TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系。但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流一样。当然接收方的应用程序必须有能力识别收到的字节流，把它还原成有意义的应用层数据。

TCP连接是一条**虚连接**（也就是逻辑连接），而不是一条真正的物理连接。TCP报文段先要传送到IP层，加上IP首部后，在传送到数据链路层，再加上数据链路层的首部和尾部后，才离开主机发送到物理链路。

TCP和UDP在发送报文时所采用的方式完全不同。TCP并不关心应用进程一次把多大的报文发送到TCP的缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP发送的报文长度是应用进程给出的）。如果应用进程传送到TCP缓存的数据太长，TCP就可以把它划分短一些再发送。如果应用程序一次只发来一个字节，TCP也可以等待激烈积累有足够多的字节后在构成报文段发送出去。

#### 2. TCP的连接

TCP把连接作为最基本的抽象。

套接字 socket =（IP地址 ：端口号）

同一个IP地址可以有多个不同的TCP连接，而同一个端口也可以出现在多个不同的TCP连接中。

### 2. 可靠传输的工作原理

TCP发送的报文段是交给IP层传送，但IP层只能提供尽最大努力服务，也就是说，TCP下面的网络所提供的是不可靠的传输。因此，TCP必须采取适当的措施才能使得两个运输层之间的通信变得可靠。

理想的传输条件特点：

1. 传输信道不产生差错。
2. 不管发送方以多快的速度发送数据，接收方总是来得及从处理收到的数据。

#### 1. 停止等待协议

“停止等待”就是每发送完一个分组就停止发送，等待对方的确认，在收到确认后再发送下一个分组。

![停止等待协议](https://github.com/chenshuaiyu/Notes/blob/master/Network/assets/停止等待协议.PNG)

超时重传：

1. A在发送完一个分组后，必须暂时保留已发送的分组的副本（在发生超时重传时使用）。只有在收到相应的确认后才能清除暂时保留的分组副本。
2. 分组和确认都必须进行编号，这样才能明确哪一个发送出去的分组收到了确认，而哪一个分组还没有收到确认。
3. 超时计时器设置的重传时间应当比数据在分组传输的平均往返时间更长一些。

![确认丢失和确认迟到](https://github.com/chenshuaiyu/Notes/blob/master/Network/assets/确认丢失和确认迟到.PNG)

确认丢失：
假定B又收到了重传的分组M1，这时应采取两个活动：

1. 丢弃这个重复的分组，不向上层交付。
2. 向A发送确认，不能认为已经发送过确认就不再发送，因为A之所以重传就表示A没有收到对M1的确认。

确认迟到：

B对分组M1的确认迟到了，A会收到重复的确认。对重复的确认的处理很简单：收下就丢弃。B仍然会收到重复的M1，并且同样要丢弃重复的M1，并重传确认分组。

信道利用率：

![停止等待协议的信道利用率太低](https://github.com/chenshuaiyu/Notes/blob/master/Network/assets/停止等待协议的信道利用率太低.PNG)
$$
U=\frac{T_D}{T_D+RTT+T_A}
$$

- T_D：发送分组时间
- RTT：往返时间
- T_A：发送确认分组时间

#### 2. 连续ARQ协议

![连续ARQ协议的工作原理](https://github.com/chenshuaiyu/Notes/blob/master/Network/assets/连续ARQ协议的工作原理.PNG)

连续ARQ协议规定：

发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。

接受方一般都是采用累积确认的方法。这就是说，接受方不必对收到的分组逐个发送确认，而是在收到几个分组后，对按序到达的租后一个分组发送确认，这就表示：到这个分组为止的所有分组都已经正确收到了。

- 优点：容易实现，即使确认丢失也不必重传。
- 缺点：不能向发送方反映出接受方已经正确收到的所有分组的信息。

Go-back-N（后退N）：表示需要再退回来重传已发送过的N个分组。

### 3. TCP报文的首部格式

![TCP报文段的首部格式](https://github.com/chenshuaiyu/Notes/blob/master/Network/assets/TCP报文段的首部格式.PNG)

### 4. TCP可靠传输的实现







